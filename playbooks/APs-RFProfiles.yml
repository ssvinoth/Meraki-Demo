---
# takes variable network_name
- name: Create AP Wireless Profiles
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Include Wifi psks vault vars
      ansible.builtin.include_vars:
        file: ../vars/cac/wifi_psks_vault.yml   
        
    - name: Get Organization Networks
      cisco.meraki.networks_info:
        meraki_api_key: "{{ meraki_key }}"
        organizationId: "{{ org_id }}"
      register: result
      
    - name: Filter networks with "wireless" productTypes
      set_fact:
        #filtered_networks: "{{ result.meraki_response | selectattr('productTypes', 'contains', 'wireless') | selectattr('name', 'equalto', network_name) |  list }}"
        filtered_networks: "{{ result.meraki_response | selectattr('name', 'equalto', network_name) |  list }}"
      register: network_id_get
      
    - name: Create AP wireless profile
      cisco.meraki.networks_camera_wireless_profiles:
        meraki_api_key: "{{ meraki_key }}"
        state: present
        name: Demo-RF-Profile
        networkId: "{{ filtered_networks.0.id }}"
        ssid:
          name: "MyCompany_cameras"
          authMode: "psk"
          psk: "{{ SSID_PSKS['MyCompany_cameras'] | default(SSID_PSKS['default_psk']) }}"
